<div class="search-form-wrapper">
    <form action="{% url 'properties:property-list' %}" method="get" class="search-form">
        <div class="input-wrapper">
            <input type="text" name="location" id="location-input" placeholder="Enter city, state, or country..."
                value="{{ location_query }}" autocomplete="off" {% if required %}required{% endif %}>
            <div id="autocomplete-dropdown" class="autocomplete-dropdown"></div>
        </div>
        <button type="submit">Search</button>
    </form>
</div>

<style>
    .search-form-wrapper {
        margin-bottom: 30px;
    }

    .search-form {
        display: flex;
        gap: 10px;
    }

    .input-wrapper {
        flex: 1;
        position: relative;
    }

    .search-form input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .search-form button {
        padding: 12px 30px;
        background: #3498db;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        white-space: nowrap;
    }

    .search-form button:hover {
        background: #2980b9;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }

    .autocomplete-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .autocomplete-item:hover {
        background: #f8f9fa;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }
</style>

<script>
    const input = document.getElementById('location-input');
    const dropdown = document.getElementById('autocomplete-dropdown');
    let debounceTimer;

    input.addEventListener('input', function () {
        clearTimeout(debounceTimer);
        const query = this.value.trim();

        if (query.length < 2) {
            dropdown.style.display = 'none';
            return;
        }

        debounceTimer = setTimeout(() => {
            fetch(`/api/locations/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.locations && data.locations.length) {
                        dropdown.innerHTML = data.locations.map(loc =>
                            `<div class="autocomplete-item" data-value="${loc.city}">${loc.text}</div>`
                        ).join('');
                        dropdown.style.display = 'block';
                    } else {
                        dropdown.style.display = 'none';
                    }
                });
        }, 300);
    });

    dropdown.addEventListener('click', function (e) {
        if (e.target.classList.contains('autocomplete-item')) {
            input.value = e.target.dataset.value;
            dropdown.style.display = 'none';
        }
    });

    document.addEventListener('click', function (e) {
        if (!input.closest('.input-wrapper')) {
            dropdown.style.display = 'none';
        }
    });
</script>